<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat Rooms</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #f4f7f6; 
            color: #333; 
            margin: 0; 
        }
        .header {
            background-color: #ff69b4;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .header h1 { margin: 0; font-size: 1.5em; }
        
        /* --- Profile and Balance --- */
        .profile-section {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .profile-section:hover { background: rgba(255, 255, 255, 0.1); }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }
        .user-info {
            margin-left: 10px;
            text-align: left;
        }
        .user-info strong {
            display: block;
            font-size: 1.1em;
        }
        .user-balance span {
            display: inline-block;
            margin-right: 10px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
        }
        .diamond-icon { color: #00bcd4; }
        .coin-icon { color: gold; }

        /* --- Room Grid --- */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: auto;
        }
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .room-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        .room-header {
            background-color: #5c677d;
            color: white;
            padding: 10px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-header.vip {
            background-color: #ffc107;
            color: #333;
            font-weight: bold;
        }
        .room-details {
            padding: 15px;
            display: flex;
            align-items: center;
        }
        .owner-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid #ff69b4;
        }
        .room-info h3 {
            margin: 0 0 5px;
            color: #ff69b4;
        }
        .room-info p {
            margin: 0;
            font-size: 0.9em;
            color: #777;
        }

        /* --- Create Room Button --- */
        #createRoomBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #00bcd4;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background 0.2s;
        }
        #createRoomBtn:hover {
            background-color: #0097a7;
        }

        /* --- Modal for Room Creation --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content input[type="text"], 
        .modal-content button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content button {
            background-color: #ff69b4;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="profile-section" onclick="goToProfile()">
        <img id="userProfilePic" class="profile-img" src="https://i.pravatar.cc/150?img=1" alt="Profile">
        <div class="user-info">
            <strong id="currentUsername">Guest</strong>
            <div class="user-balance">
                <span onclick="goToRecharge(event)" class="diamond-icon">ðŸ’Ž <span id="userDiamondBalance">0</span>+</span>
                <span class="coin-icon">ðŸ’° <span id="userCoinBalance">0</span></span>
                <span id="userLevel">LVL 0</span>
            </div>
        </div>
    </div>
    <h1>Voice Rooms</h1>
    <a href="/" onclick="localStorage.removeItem('currentUser')">Logout</a>
</div>

<div class="container">
    <h2>Available Rooms</h2>
    <p id="roomMessage">Loading rooms...</p>
    <div class="room-grid" id="roomGrid">
        </div>
</div>

<button id="createRoomBtn">âž• Create New Room</button>

<div id="roomModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Create a Voice Room</h2>
        <form id="roomCreationForm">
            <label for="roomName">Room Name:</label>
            <input type="text" id="roomName" placeholder="Enter room name" required maxlength="30">
            
            <label>
                <input type="checkbox" id="isVIP" value="VIP">
                Make VIP Room (Cost: 200 ðŸ’Ž)
            </label>
            <p id="roomCreationMessage" style="color: red;"></p>
            <button type="submit">Create Room</button>
        </form>
    </div>
</div>

<script>
    const API_URL = ''; // Same domain
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));

    if (!currentUser) {
        window.location.href = '/';
    } else {
        updateUserInfo(currentUser);
        fetchRooms();
    }
    
    // --- Helper Functions ---
    function updateUserInfo(user) {
        currentUser = user; // Update the global currentUser object
        localStorage.setItem('currentUser', JSON.stringify(user));
        document.getElementById('currentUsername').textContent = user.username;
        document.getElementById('userDiamondBalance').textContent = user.diamonds;
        document.getElementById('userCoinBalance').textContent = user.coins || 0;
        document.getElementById('userLevel').textContent = `LVL ${user.level || 0}`;
        document.getElementById('userProfilePic').src = user.profilePic || 'https://i.pravatar.cc/150?img=1';
    }

    function goToRecharge(e) {
        e.stopPropagation(); // Prevent the whole profile section click
        window.location.href = '/recharge.html';
    }
    
    function goToProfile() {
        window.location.href = '/profile.html';
    }

    function closeModal() {
        document.getElementById('roomModal').style.display = 'none';
        document.getElementById('roomCreationForm').reset();
        document.getElementById('roomCreationMessage').textContent = '';
    }
    
    function openRoom(roomId) {
        window.location.href = `/room.html?id=${roomId}`;
    }

    // --- Core Logic ---

    // 1. Fetch Rooms and Render
    async function fetchRooms() {
        document.getElementById('roomMessage').textContent = 'Loading rooms...';
        try {
            const response = await fetch(`${API_URL}/api/rooms`);
            const data = await response.json();

            if (data.success && data.rooms.length > 0) {
                renderRooms(data.rooms);
                document.getElementById('roomMessage').textContent = '';
            } else {
                document.getElementById('roomMessage').textContent = 'No rooms found. Be the first to create one!';
                document.getElementById('roomGrid').innerHTML = '';
            }
        } catch (error) {
            document.getElementById('roomMessage').textContent = 'Error loading rooms. Please check server connection.';
            console.error('Error fetching rooms:', error);
        }
    }

    function renderRooms(rooms) {
        const grid = document.getElementById('roomGrid');
        grid.innerHTML = '';
        rooms.forEach(room => {
            const card = document.createElement('div');
            card.className = 'room-card';
            card.onclick = () => openRoom(room.roomId);
            
            card.innerHTML = `
                <div class="room-header ${room.isVIP ? 'vip' : ''}">
                    <span>${room.name}</span>
                    <span>${room.isVIP ? 'ðŸŒŸ VIP' : 'ðŸŽ§ Public'} | LVL ${room.roomLevel}</span>
                </div>
                <div class="room-details">
                    <img class="owner-img" src="${room.ownerProfilePic}" alt="Owner">
                    <div class="room-info">
                        <h3>Room ID: ${room.roomId}</h3>
                        <p>Owner: ${room.ownerUsername}</p>
                        <p>Total Listeners: 0 (Live Count Needed)</p>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // 2. Handle Room Creation
    document.getElementById('createRoomBtn').onclick = () => {
        document.getElementById('roomModal').style.display = 'block';
    };

    document.getElementById('roomCreationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const roomName = document.getElementById('roomName').value;
        const isVIP = document.getElementById('isVIP').checked;
        const messageEl = document.getElementById('roomCreationMessage');
        
        messageEl.textContent = 'Creating room...';

        try {
            const response = await fetch(`${API_URL}/api/room/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: currentUser.username, 
                    roomName, 
                    isVIP 
                })
            });

            const data = await response.json();

            if (data.success) {
                messageEl.textContent = 'Room created! Redirecting...';
                
                // Update local diamonds if VIP room was purchased
                if (data.newDiamondBalance !== undefined) {
                    currentUser.diamonds = data.newDiamondBalance;
                    updateUserInfo(currentUser);
                }
                
                closeModal();
                openRoom(data.room.roomId); // Go to the newly created room

            } else {
                messageEl.textContent = 'Error: ' + data.message;
            }

        } catch (error) {
            messageEl.textContent = 'Network Error: Could not reach server.';
            console.error('Room creation error:', error);
        }
    });

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('roomModal');
        if (event.target === modal) {
            closeModal();
        }
    };
</script>
</body>
    </html>
            
