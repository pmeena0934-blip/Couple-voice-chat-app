<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .header { background-color: #ff69b4; color: white; padding: 10px; margin: -20px -20px 20px -20px; display: flex; align-items: center; }
        .back-btn { color: white; font-size: 1.2em; text-decoration: none; padding: 5px; margin-right: 15px; }
        h1 { margin: 0; font-size: 1.5em; }
        
        .profile-container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .profile-info { text-align: center; margin-bottom: 20px; }
        .profile-img-lg { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #00bcd4; margin-bottom: 10px; }
        
        .level-badge { 
            background: linear-gradient(45deg, #00bcd4, #0097a7); 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-weight: bold; 
            display: inline-block;
        }
        .balance-box { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin-top: 15px; 
            font-size: 1.1em; 
            font-weight: bold;
        }

        /* --- Form Styling --- */
        form label { display: block; margin-top: 15px; font-weight: bold; }
        form input[type="text"], form button, form input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        form button {
            background-color: #ff69b4;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1.1em;
        }
        #coinExchangeBtn {
            background-color: gold;
            color: #333;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="header">
    <a href="/rooms.html" class="back-btn">‚¨ÖÔ∏è</a>
    <h1>Profile Settings</h1>
</div>

<div class="profile-container">
    <div class="profile-info">
        <img id="currentProfilePic" class="profile-img-lg" src="https://i.pravatar.cc/150?img=1" alt="Profile">
        <h2 id="currentUsernameDisplay">Guest</h2>
        <span id="userLevelDisplay" class="level-badge">LVL 0</span>
        <div class="balance-box">
            <span class="diamond-icon">üíé <span id="userDiamondBalance">0</span></span>
            <span class="coin-icon">üí∞ <span id="userCoinBalance">0</span></span>
        </div>
    </div>
    
    <button id="coinExchangeBtn" onclick="exchangeCoins()">Exchange All Coins for Diamonds (100 üí∞ = 10 üíé)</button>
    <p id="exchangeMessage" style="text-align: center; color: green; margin-top: 5px;"></p>
    
    <form id="profileEditForm">
        <h2>Edit Details</h2>
        
        <label for="newProfilePic">Change Profile Photo (From Gallery):</label>
        <input type="file" id="newProfilePic" name="profilePic" accept="image/*">
        
        <label for="newUsername">Change Username:</label>
        <input type="text" id="newUsername" placeholder="Enter new username">
        
        <p id="profileMessage" style="color: red;"></p>
        <button type="submit">Save Changes</button>
    </form>
</div>

<script>
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const API_URL = ''; 

    if (!currentUser) {
        window.location.href = '/';
    } else {
        displayUserInfo(currentUser);
    }

    function displayUserInfo(user) {
        document.getElementById('currentProfilePic').src = user.profilePic || 'https://i.pravatar.cc/150?img=1';
        document.getElementById('currentUsernameDisplay').textContent = user.username;
        document.getElementById('newUsername').value = user.username;
        document.getElementById('userDiamondBalance').textContent = user.diamonds;
        document.getElementById('userCoinBalance').textContent = user.coins || 0;
        document.getElementById('userLevelDisplay').textContent = `LVL ${user.level || 0}`;
        localStorage.setItem('currentUser', JSON.stringify(user));
    }

    // --- Profile Edit Submission ---
    document.getElementById('profileEditForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newUsername = document.getElementById('newUsername').value.trim();
        const profilePicFile = document.getElementById('newProfilePic').files[0];
        const messageEl = document.getElementById('profileMessage');
        messageEl.textContent = 'Saving changes...';
        
        const formData = new FormData();
        formData.append('currentUsername', currentUser.username);
        
        if (newUsername && newUsername !== currentUser.username) {
            formData.append('newUsername', newUsername);
        }
        if (profilePicFile) {
            formData.append('profilePic', profilePicFile);
        }

        if (formData.has('newUsername') || formData.has('profilePic')) {
            try {
                const response = await fetch(`${API_URL}/api/user/profile/update`, {
                    method: 'POST',
                    body: formData 
                });
    
                const data = await response.json();
    
                if (data.success) {
                    messageEl.style.color = 'green';
                    messageEl.textContent = data.message;
                    
                    // Update user info globally
                    currentUser = data.user;
                    displayUserInfo(currentUser);
                    
                } else {
                    messageEl.style.color = 'red';
                    messageEl.textContent = 'Error: ' + data.message;
                }
            } catch (error) {
                messageEl.style.color = 'red';
                messageEl.textContent = 'Network Error. Could not save profile.';
                console.error('Profile update error:', error);
            }
        } else {
            messageEl.style.color = 'red';
            messageEl.textContent = 'No changes detected.';
        }
    });
    
    // --- Coin Exchange Logic ---
    async function exchangeCoins() {
        const messageEl = document.getElementById('exchangeMessage');
        const coins = parseInt(document.getElementById('userCoinBalance').textContent);

        if (coins < 100) {
            messageEl.style.color = 'red';
            messageEl.textContent = 'Minimum 100 Coins required for exchange.';
            return;
        }

        messageEl.style.color = 'blue';
        messageEl.textContent = 'Exchanging coins...';
        
        try {
            const response = await fetch(`${API_URL}/api/exchange/coin-to-diamond`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser.username })
            });
            
            const data = await response.json();

            if (data.success) {
                messageEl.style.color = 'green';
                messageEl.textContent = data.message;
                
                // Update user object and UI
                currentUser.diamonds = data.newDiamondBalance;
                currentUser.coins = data.newCoinBalance;
                displayUserInfo(currentUser);
                
            } else {
                messageEl.style.color = 'red';
                messageEl.textContent = 'Exchange Failed: ' + data.message;
            }

        } catch (error) {
            messageEl.style.color = 'red';
            messageEl.textContent = 'Network Error during exchange.';
            console.error('Exchange error:', error);
        }
    }
</script>
</body>
      </html>
  
